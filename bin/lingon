#!/usr/bin/env node

'use strict';

var fs      = require('fs');
var spawn   = require('child_process').spawn;
var chalk   = require('chalk');
var Liftoff = require('liftoff');
var argv    = require('minimist')(process.argv.slice(2));

function log() {
  console.log.apply(null, ["[ " + chalk.green('Lingon CLI') + " ]"].concat(
    Array.prototype.slice.call(arguments, 0)
  ));
}

if(!!argv.v || argv._[0] == 'version') {
  var pkg = require('../package.json');
  log('Lingon CLI version:', pkg.version);
}


if (argv._[0] == 'new') {
  var projectName = argv._[1];
  var args = ['clone','git@github.com:jpettersson/lingon-ng-template.git']

  if (projectName) {
    args.push(projectName);
  };

  log(chalk.green('Creating lingon project...'));

  // TODO: check if project (folder) with this name already exists

  // Clone lingon template
  var gitClone = spawn('git', args, { stdio: 'inherit', cwd: process.cwd });
  gitClone.on('exit', function(c) {
    if (c !== 0) { return; }

    // TODO: Replace all string occurences of project-name with specified project name argument (?)

    // TODO: Run npm and bower install (?)

    log(chalk.green('All done!'));
    process.exit()
  });

  return;
};

var cli = new Liftoff({
  processTitle: 'lingon',
  moduleName: 'lingon',
  configName: 'lingon'
});

cli.launch(function handleArguments(env) {
  var argv = env.argv;

  if (!env.configPath) {
    log(chalk.red('No lingon.js file found'));
    process.exit(1);
  }

  if (!env.modulePath) {
    log(chalk.red('No local lingon install found in'), chalk.magenta(env.cwd));
    log(chalk.yellow('Try running: npm install lingon'));
    process.exit(1);
  }

  global.lingonCliVersion = env.modulePackage.version;

  // Change working directory to the one containing lingon.js
  process.chdir(env.configBase);

  // Start new lingon sub process
  var lingonProcess;
  var spawnLingonProcess = function spawnLingonProcess() {
    if(lingonProcess) {
      log('Configuration changed. Restarting Lingon process!');
      lingonProcess.removeAllListeners('exit');
      lingonProcess.kill();
      lingonProcess = null;
    }

    lingonProcess = spawn(env.configPath, process.argv.slice(2), { stdio: 'inherit' });
    lingonProcess.on('exit', function() {
      process.exit();
    })
  };

  // setting up a file watcher to reload the lingon process when the
  // lingon.js file has been modified
  var lingonFileWatch;
  var setupWatcher = function setupWatcher() {
    lingonFileWatch = fs.watch(env.configPath, function() {
      lingonFileWatch.close();
      spawnLingonProcess();

      // wait a moment until continuing to watch for changes, that way
      // any swap files will be resolved and multiple events per change
      // can _hopefully_ be prevented
      setTimeout(function() {
        setupWatcher();
      }, 3000);
    });
  };

  spawnLingonProcess();
  setupWatcher();
});
